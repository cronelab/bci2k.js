(function(d,m){typeof exports=="object"&&typeof module<"u"?m(exports,require("websocket")):typeof define=="function"&&define.amd?define(["exports","websocket"],m):(d=typeof globalThis<"u"?globalThis:d||self,m(d.bci2k={},d.websocket))})(this,function(d,m){"use strict";const S=m.w3cwebsocket;class x{constructor(a){this.ondisconnect=()=>{},this.onStateChange=s=>{},this.websocket=null,this.state="",this.address=a||void 0,this.latestIncomingData="",this.msgID=0,this.newData=()=>{}}connect(a){return new Promise((s,t)=>{this.address===void 0&&(this.address=a||"ws://127.0.0.1:80"),this.websocket=new S(this.address),this.websocket.onerror=i=>t(`Error connecting to BCI2000 at ${this.address}`),this.websocket.onclose=()=>{this.ondisconnect()},this.websocket.onopen=()=>s(),this.websocket.onmessage=({data:i})=>{this.newData(i)}})}disconnect(){this.websocket.close()}connected(){return this.websocket!==null&&this.websocket.readyState===S.OPEN}execute(a){return this.connected()?new Promise((s,t)=>{this.websocket.send(a),this.newData=i=>{console.log(i.includes("Error: ")),i.includes("Error: ")?t(i):s(i)}}):Promise.reject("Cannot execute instruction: not connected to BCI2000")}async getVersion(){return(await this.execute("Version")).split("\r")[0]}async showWindow(){await this.execute("Show Window")}async hideWindow(){await this.execute("Hide Window")}async startExecutable(a){await this.execute(`Start executable ${a}`)}async startDummyRun(){await this.startExecutable("SignalGenerator"),await this.startExecutable("DummySignalProcessing"),await this.startExecutable("DummyApplication")}async setWatch(a,s,t){await this.execute("Add watch "+a+" at "+s+":"+t)}async resetSystem(){await this.execute("Reset System")}async setConfig(){await this.execute("Set Config")}async start(){await this.execute("Start")}async stop(){await this.execute("Stop")}async kill(){await this.execute("Exit")}stateListen(){setInterval(async()=>{let a=await this.execute("GET SYSTEM STATE");a.trim()!=this.state&&this.onStateChange(a.trim())},1e3)}async getSubjectName(){return await this.execute("Get Parameter SubjectName")}async getTaskName(){return await this.execute("Get Parameter DataFile")}async setParameter(a){await this.execute(`Set paramater ${a}`)}async setState(a){await this.execute(`Set state ${a}`)}async getParameters(){let s=(await this.execute("List Parameters")).split(`
`),t={},i;return s.forEach(e=>{let n=e.split("=")[0],r=n.split(" ")[1],l=n.split(" ")[2],o=n.split(" ")[0].split(":");o.forEach((g,h)=>{switch(h){case 0:{t[o[0]]==null&&(t[o[0]]={}),i=t[o[0]];break}case 1:{t[o[0]][o[1]]==null&&(t[o[0]][o[1]]={}),i=t[o[0]][o[1]];break}case 2:{t[o[0]][o[1]][o[2]]==null&&(t[o[0]][o[1]][o[2]]={}),i=t[o[0]][o[1]][o[2]];break}}}),r!="matrix"?e.split("=")[1].split("//")[0].trim().split(" ").length==4?i[l]={dataType:r,value:{value:e.split("=")[1].split("//")[0].trim().split(" ")[0],defaultValue:e.split("=")[1].split("//")[0].trim().split(" ")[1],low:e.split("=")[1].split("//")[0].trim().split(" ")[2],high:e.split("=")[1].split("//")[0].trim().split(" ")[3]},comment:e.split("=")[1].split("//")[1]}:i[l]={dataType:r,value:e.split("=")[1].split("//")[0].trim(),comment:e.split("=")[1].split("//")[1]}:i[l]={dataType:r,value:e.split("=")[1].split("//")[0].trim(),comment:e.split("=")[1].split("//")[1]}}),t}}const k=m.w3cwebsocket;class P{constructor(a){this._socket=null,this.onconnect=()=>{},this.onGenericSignal=s=>{},this.onStateVector=s=>{},this.onSignalProperties=s=>{},this.onStateFormat=s=>{},this.ondisconnect=()=>{},this.onReceiveBlock=()=>{},this.callingFrom="",this.states={},this.signal=null,this.signalProperties=null,this.stateFormat=null,this.stateVecOrder=null,this.SignalType={INT16:0,FLOAT24:1,FLOAT32:2,INT32:3},this.address=a}getNullTermString(a){var s="";let t=0;for(;t<a.byteLength;){var i=a.getUint8(t);if(t++,i==0)break;s+=String.fromCharCode(i)}return s}connect(a,s){let t=this;return t.address===void 0&&(t.address=a),this.callingFrom=s,new Promise((i,e)=>{t._socket=new k(t.address),t._socket.binaryType="arraybuffer",t._socket.onerror=()=>{e("Error connecting to data source at "+t.address)},t._socket.onopen=()=>{t.onconnect(),i()},t._socket.onclose=()=>{t.ondisconnect(),setTimeout(()=>{console.log("Disconnected"),this.connect("")},1e3)},t._socket.onmessage=n=>{t._decodeMessage(n.data)}})}connected(){return this._socket!=null&&this._socket.readyState===k.OPEN}_decodeMessage(a){let s=new DataView(a,0,1).getUint8(0);switch(s){case 3:let t=new DataView(a,1,a.byteLength-1);this._decodeStateFormat(t);break;case 4:let i=new DataView(a,1,2).getUint8(0);switch(i){case 1:let n=new DataView(a,2,a.byteLength-2);this._decodeGenericSignal(n);break;case 3:let r=new DataView(a,2,a.byteLength-2);this._decodeSignalProperties(r);break;default:console.error("Unsupported Supplement: "+i.toString());break}this.onReceiveBlock();break;case 5:let e=new DataView(a,1,a.byteLength-1);this._decodeStateVector(e);break;default:console.error("Unsupported Descriptor: "+s.toString());break}}_decodePhysicalUnits(a){let s;s={};let t=a.split(" "),i=0;return s.offset=Number(t[i++]),s.gain=Number(t[i++]),s.symbol=t[i++],s.vmin=Number(t[i++]),s.vmax=Number(t[i++]),s}_decodeSignalProperties(a){let s=this.getNullTermString(a);s=s.replace(/{/g," { "),s=s.replace(/}/g," } "),this.signalProperties={};let t=s.split(" "),i=[];for(let n=0;n<t.length;n++)t[n].trim()!==""&&i.push(t[n]);let e=0;if(this.signalProperties.name=i[e++],this.signalProperties.channels=[],i[e]==="{"){for(;i[++e]!=="}";)this.signalProperties.channels.push(i[e]);e++}else{let n=parseInt(i[e++]);for(let r=0;r<n;r++)this.signalProperties.channels.push((r+1).toString())}if(this.signalProperties.elements=[],i[e]==="{"){for(;i[++e]!=="}";)this.signalProperties.elements.push(i[e]);e++}else{let n=parseInt(i[e++]);for(let r=0;r<n;r++)this.signalProperties.elements.push((r+1).toString())}this.signalProperties.numelements=this.signalProperties.elements.length,this.signalProperties.signaltype=i[e++],this.signalProperties.channelunit=this._decodePhysicalUnits(i.slice(e,e+=5).join(" ")),this.signalProperties.elementunit=this._decodePhysicalUnits(i.slice(e,e+=5).join(" ")),e++,this.signalProperties.valueunits=[];for(let n=0;n<this.signalProperties.channels.length;n++)this.signalProperties.valueunits.push(this._decodePhysicalUnits(i.slice(e,e+=5).join(" ")));e++,this.onSignalProperties(this.signalProperties)}_decodeStateFormat(a){this.stateFormat={};let t=this.getNullTermString(a).split(`
`);for(let e=0;e<t.length;e++){if(t[e].trim().length===0)continue;let n=t[e].split(" "),r=n[0];this.stateFormat[r]={},this.stateFormat[r].bitWidth=parseInt(n[1]),this.stateFormat[r].defaultValue=parseInt(n[2]),this.stateFormat[r].byteLocation=parseInt(n[3]),this.stateFormat[r].bitLocation=parseInt(n[4])}let i=[];for(let e in this.stateFormat){let n=this.stateFormat[e].byteLocation*8;n+=this.stateFormat[e].bitLocation,i.push([e,n])}i.sort((e,n)=>e[1]<n[1]?-1:e[1]>n[1]?1:0),this.stateVecOrder=[];for(let e=0;e<i.length;e++){let n=i[e][0];this.stateVecOrder.push([n,this.stateFormat[n].bitWidth])}this.onStateFormat(this.stateFormat)}_decodeGenericSignal(a){let s=0,t=a.getUint8(s);s=s+1;let i=a.getUint16(s,!0);s=s+2;let e=a.getUint16(s,!0);s=s+2,s=s+a.byteOffset;let n=new DataView(a.buffer,s),r=[];for(let l=0;l<i;++l){r.push([]);for(let o=0;o<e;++o)switch(t){case this.SignalType.INT16:r[l].push(n.getInt16((e*l+o)*2,!0));break;case this.SignalType.FLOAT32:r[l].push(n.getFloat32((e*l+o)*4,!0));break;case this.SignalType.INT32:r[l].push(n.getInt32((e*l+o)*4,!0));break;case this.SignalType.FLOAT24:r[l].push(0);break}}this.signal=r,this.onGenericSignal(r)}_decodeStateVector(a){if(this.stateVecOrder==null)return;let s=new Int8Array(a.buffer),t=s.indexOf(0),i=s.indexOf(0,t+1),e=new TextDecoder,n=parseInt(e.decode(s.slice(1,t))),r=parseInt(e.decode(s.slice(t+1,i))),l=i+1,o=new DataView(a.buffer,l),g={};for(let h in this.stateFormat)g[h]=Array(r).fill(this.stateFormat[h].defaultValue);for(let h=0;h<r;h++){let u=new Uint8Array(o.buffer,o.byteOffset+h*n,n),p=[];for(let c=0;c<u.length;c++)p.push(u[c]&1?1:0),p.push(u[c]&2?1:0),p.push(u[c]&4?1:0),p.push(u[c]&8?1:0),p.push(u[c]&16?1:0),p.push(u[c]&32?1:0),p.push(u[c]&64?1:0),p.push(u[c]&128?1:0);for(let c=0;c<this.stateVecOrder.length;c++){let w=this.stateFormat[this.stateVecOrder[c][0]],I=w.byteLocation*8+w.bitLocation,f=0,b=1;for(let y=0;y<w.bitWidth;y++)p[I+y]&&(f=(f|b)>>>0),b=b<<1>>>0;g[this.stateVecOrder[c][0]][h]=f}}this.onStateVector(g),this.states=g}}d.BCI2K_DataConnection=P,d.BCI2K_OperatorConnection=x,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
